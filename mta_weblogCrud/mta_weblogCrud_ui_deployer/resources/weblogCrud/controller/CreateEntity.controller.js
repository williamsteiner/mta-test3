sap.ui.define(["com/owi/webmin/weblogCrud/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(e,t,i){"use strict";return e.extend("com.owi.webmin.weblogCrud.controller.CreateEntity",{_oBinding:{},onInit:function(){var e=this;this.getRouter().getTargets().getTarget("create").attachDisplay(null,this._onDisplay,this);this._oODataModel=this.getOwnerComponent().getModel();this._oResourceBundle=this.getResourceBundle();this._oViewModel=new t({enableCreate:false,delay:0,busy:false,mode:"create",viewTitle:""});this.setModel(this._oViewModel,"viewModel");sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);var i=sap.ui.getCore().getMessageManager().getMessageModel();this._oBinding=new sap.ui.model.Binding(i,"/",i.getContext("/"));this._oBinding.attachChange(function(t){var i=t.getSource().getModel().getData();for(var s=0;s<i.length;s++){if(i[s].type==="Error"&&!i[s].technical){e._oViewModel.setProperty("/enableCreate",false)}}})},onSave:function(){var e=this,t=this.getModel();if(!t.hasPendingChanges()){i.information(this._oResourceBundle.getText("noChangesMessage"),{id:"noChangesInfoMessageBox",styleClass:e.getOwnerComponent().getContentDensityClass()});return}this.getModel("appView").setProperty("/busy",true);if(this._oViewModel.getProperty("/mode")==="edit"){t.attachEventOnce("batchRequestCompleted",function(t){if(e._checkIfBatchRequestSucceeded(t)){e._fnUpdateSuccess()}else{e._fnEntityCreationFailed();i.error(e._oResourceBundle.getText("updateError"))}})}t.submitChanges()},_checkIfBatchRequestSucceeded:function(e){var t=e.getParameters();var i=e.getParameters().requests;var s;if(t.success){if(i){for(var r=0;r<i.length;r++){s=e.getParameters().requests[r];if(!s.success){return false}}}return true}else{return false}},onCancel:function(){if(this.getModel().hasPendingChanges()){this._showConfirmQuitChanges()}else{this.getModel("appView").setProperty("/addEnabled",true);this._navBack()}},_navBack:function(){var e=sap.ui.core.routing.History.getInstance(),t=e.getPreviousHash();this.getView().unbindObject();if(t!==undefined){history.go(-1)}else{this.getRouter().getTargets().display("object")}},_showConfirmQuitChanges:function(){var e=this.getOwnerComponent(),t=this.getModel();var s=this;i.confirm(this._oResourceBundle.getText("confirmCancelMessage"),{styleClass:e.getContentDensityClass(),onClose:function(e){if(e===sap.m.MessageBox.Action.OK){s.getModel("appView").setProperty("/addEnabled",true);t.resetChanges();s._navBack()}}})},_onEdit:function(e){var t=e.getParameter("data"),i=this.getView();this._oViewModel.setProperty("/mode","edit");this._oViewModel.setProperty("/enableCreate",true);this._oViewModel.setProperty("/viewTitle",this._oResourceBundle.getText("editViewTitle"));i.bindElement({path:t.objectPath})},_onCreate:function(e){if(e.getParameter("name")&&e.getParameter("name")!=="create"){this._oViewModel.setProperty("/enableCreate",false);this.getRouter().getTargets().detachDisplay(null,this._onDisplay,this);this.getView().unbindObject();return}this._oViewModel.setProperty("/viewTitle",this._oResourceBundle.getText("createViewTitle"));this._oViewModel.setProperty("/mode","create");var t=this._oODataModel.createEntry("weblog",{success:this._fnEntityCreated.bind(this),error:this._fnEntityCreationFailed.bind(this)});this.getView().setBindingContext(t)},_validateSaveEnablement:function(){var e=this._getFormFields(this.byId("newEntitySimpleForm"));var t;for(var i=0;i<e.length;i++){t=e[i].control;if(e[i].required){var s=t.getValue();if(!s){this._oViewModel.setProperty("/enableCreate",false);return}}}this._checkForErrorMessages()},_checkForErrorMessages:function(){var e=this._oBinding.oModel.oData;if(e.length>0){var t=true;for(var i=0;i<e.length;i++){if(e[i].type==="Error"&&!e[i].technical){t=false;break}}this._oViewModel.setProperty("/enableCreate",t)}else{this._oViewModel.setProperty("/enableCreate",true)}},_fnUpdateSuccess:function(){this.getModel("appView").setProperty("/busy",false);this.getView().unbindObject();this.getRouter().getTargets().display("object")},_fnEntityCreated:function(e){var t=this.getModel().createKey("weblog",e);this.getModel("appView").setProperty("/itemToSelect","/"+t);this.getModel("appView").setProperty("/busy",false);this.getRouter().getTargets().display("object")},_fnEntityCreationFailed:function(){this.getModel("appView").setProperty("/busy",false)},_onDisplay:function(e){var t=e.getParameter("data");if(t&&t.mode==="update"){this._onEdit(e)}else{this._onCreate(e)}},_getFormFields:function(e){var t=[];var i=e.getContent();var s;for(var r=0;r<i.length;r++){s=i[r].getMetadata().getName();if(s==="sap.m.Input"||s==="sap.m.DateTimeInput"||s==="sap.m.CheckBox"){t.push({control:i[r],required:i[r-1].getRequired&&i[r-1].getRequired()})}}return t}})});